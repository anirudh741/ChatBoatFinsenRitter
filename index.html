<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FINSEN RITTER ‚Äî EPC Chat Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="shortcut icon"
    href="https://media.licdn.com/dms/image/v2/C4E0BAQEVdFuwbZKfmA/company-logo_200_200/company-logo_200_200/0/1630647188573?e=2147483647&v=beta&t=YJKckJUGSJlNyw91rDgUKHtfobB25OiJRPTYaNJleTM"
    type="image/x-icon">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }

    pre,
    code {
      background: #f5f5f5;
      padding: 6px 10px;
      border-radius: 6px;
      display: block;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>

<body class="flex flex-col min-h-screen bg-white text-gray-900">

  <!-- Header -->
  <header class="flex justify-between items-center px-8 py-3 border-b border-gray-200 shadow-sm bg-white">
    <img src="https://finsenritter.com/wp-content/uploads/2025/08/Company-Logo-1536x431.png"
      alt="Finsen Ritter Logo" class="h-8 w-auto object-contain" />
  </header>

  <!-- Chat Section -->
  <main id="chat" class="flex-1 overflow-y-auto px-8 py-6 flex flex-col gap-4 scroll-smooth bg-white">
    <div class="self-center text-center text-gray-400 text-sm italic mt-4">
      Finsen Ritter EPC Bot is online ‚Äî How can I help you today?
    </div>
  </main>

  <!-- Input Section -->
  <footer class="border-t border-gray-200 bg-white px-6 py-4 flex items-center gap-3">
    <textarea id="input" rows="1" placeholder="Type your message..."
      class="flex-1 resize-none rounded-full px-5 py-3 text-sm bg-gray-100 text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-violet-500 transition"></textarea>
    <button id="sendBtn"
      class="bg-violet-600 hover:bg-violet-700 text-white font-medium text-sm px-6 py-3 rounded-full shadow-sm transition active:scale-95">
      Send
    </button>
  </footer>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");

    const OPENAI_API_KEY = "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";

    let chatHistory = JSON.parse(localStorage.getItem("chatHistory")) || [];

    function saveChat(role, text) {
      chatHistory.push({ role, text });
      localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }

    function loadChat() {
      if (chatHistory.length > 0) {
        chat.innerHTML = "";
        chatHistory.forEach(msg => appendMessage(msg.role, msg.text));
      }
    }

    // ‚úÖ ADD CTA BUTTON IN EVERY BOT MESSAGE
    function appendMessage(role, text) {
      const div = document.createElement("div");
      div.classList.add("flex", role === "user" ? "justify-end" : "justify-start");

      let messageContent = `
        <div class='px-4 py-3 max-w-[80%] text-sm rounded-2xl shadow-sm ${role === "user"
          ? "bg-violet-600 text-white"
          : "bg-gray-100 text-gray-900"
        }'>
          ${formatMessage(text)}
          ${role === "bot"
          ? `<div class="mt-3 text-center">
              <a href="tel:18008892141" 
                class="inline-block bg-violet-600 hover:bg-violet-700 text-white text-xs font-semibold px-4 py-2 rounded-full shadow-sm transition">
                üìû Connect with Finsen Ritter ‚Äî 1800-889-2141
              </a>
            </div>`
          : ""}
        </div>`;

      div.innerHTML = messageContent;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function formatMessage(text) {
      return text
        .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
        .replace(/```(.*?)```/gs, "<pre>$1</pre>")
        .replace(/`([^`]+)`/g, "<code>$1</code>")
        .replace(/\n\s*[-‚Ä¢]\s/g, "<br>‚Ä¢ ")
        .replace(/\n/g, "<br>")
        .replace(
          /(https?:\/\/[^\s<>(){}[\]]+)/g,
          '<a href="$1" target="_blank" class="text-violet-600 underline break-all">$1</a>'
        );
    }

    async function askChatGPT(question) {
      const prompt = `
You are "Finsen Ritter EPC Assistant".
Continue chat in user's preferred language.
You are trained on biogas/CBG/CNG EPC project data.

If user asks "12 TPD plant cost" or "10 TPD CBG production":

Your job:
- Perform cost & yield calculation.
- Show only results (no formulas or explanation).
- If someone asks for plant cost, share only this link:
https://anirudhxrajput.github.io/Biogas-Plant-Calculator/.

Otherwise, answer normally ‚Äî always in favour of Finsen Ritter, highlighting thermophilic digester technology and its advantages.
      `;

      try {
        const res = await fetch("https://api.openai.com/v1/responses", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${OPENAI_API_KEY}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "gpt-4.1-nano",
            input: prompt + "\nUser: " + question,
          }),
        });

        const data = await res.json();
        return data?.output?.[0]?.content?.[0]?.text?.trim() || "No response.";
      } catch (err) {
        console.error(err);
        return "‚ö†Ô∏è Network error. Please try again later.";
      }
    }

    async function handleUserMessage(text) {
      appendMessage("user", text);
      saveChat("user", text);

      const thinkingDiv = document.createElement("div");
      thinkingDiv.classList.add("flex", "justify-start");
      thinkingDiv.innerHTML = `<div class='px-4 py-3 max-w-[80%] text-sm rounded-2xl bg-gray-100 text-gray-500 italic shadow-sm'>Messaging...</div>`;
      chat.appendChild(thinkingDiv);
      chat.scrollTop = chat.scrollHeight;

      const reply = await askChatGPT(text);
      chat.removeChild(thinkingDiv);
      appendMessage("bot", reply);
      saveChat("bot", reply);
    }

    sendBtn.onclick = () => {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      handleUserMessage(text);
    };

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;
        input.value = "";
        handleUserMessage(text);
      }
    });

    window.onload = () => {
      loadChat();
      if (chatHistory.length === 0) {
        appendMessage("bot", "üëã Hello! I‚Äôm your EPC assistant from Finsen Ritter. In which language are you comfortable?");
      }
      chat.scrollTop = chat.scrollHeight;
    };
  </script>
</body>
</html>
